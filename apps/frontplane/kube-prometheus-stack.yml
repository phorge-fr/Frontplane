apiVersion: v1
kind: Namespace
metadata:
    name: kube-prometheus-stack
sops:
    age:
        - recipient: age1ae6yk6xtlt8h40272xqxegz3t3zpvvuxj0jwy489xs6e34k0y9xsvpmt03
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBHcXNjejZIUmpwKzh0OURP
            K3FHMlNmL1BoR09PdE10WXZENWJrWityblQwCkVFc1A5cmphS2dFa0FEZlRNQlNo
            YnlOZndjT2dWc1JCRlVUdFZGZC9naDQKLS0tIFF5RWtjV0ZuUkFvZHNmK2IvWXRw
            SUs0b3grUUR2dnVlY01kVC9ZRXdNaDQKkDf3mtxiDHCfhLSnIzpYIrEgN67M/g4k
            gFh02+kf66v57nFkwAa2G7SDZ7hjvtWwVoDI7v5EMtJGYoNa9UV1nQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2026-01-03T00:27:24Z"
    mac: ENC[AES256_GCM,data:gExazvN/DeV4JKlP0AOtAdplefiym24jBbzow3zDmLaDLbZqtGDdnQaFVDMqvHu6FGbPnX2UHCPMglzqpm7wKgZ8sBG+G8YeXVKOUWzWYWvEI6o9d56QeT9NcxkbN3s8XfkKvJt00lm9Hx5ci41KqqrdLKY5Gvbuw908W3xmDBE=,iv:c9vIsPCzxP1KtEpp42LN8a12Zl4knuFbtXjNzxYLoHk=,tag:3PEOGydRwfN0sWEaOfScjQ==,type:str]
    encrypted_regex: ^(email|password|secret_key|data|stringData|ca|crt|key|id|secret|token|aggregatorCA|serviceAccount|bootstraptoken|secretboxencryptionsecret|secretboxEncryptionSecret|clientSecret|clientId|clientID|external-dns.alpha.kubernetes.io/target|adminPassword|metrics.crt|metrics.key|ca.crt|uri|postgresPassword|preshared|username)$
    version: 3.11.0
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
    name: kube-prometheus-stack
    namespace: kube-prometheus-stack
spec:
    interval: 1m0s
    timeout: 15m0s
    url: https://prometheus-community.github.io/helm-charts
sops:
    age:
        - recipient: age1ae6yk6xtlt8h40272xqxegz3t3zpvvuxj0jwy489xs6e34k0y9xsvpmt03
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBHcXNjejZIUmpwKzh0OURP
            K3FHMlNmL1BoR09PdE10WXZENWJrWityblQwCkVFc1A5cmphS2dFa0FEZlRNQlNo
            YnlOZndjT2dWc1JCRlVUdFZGZC9naDQKLS0tIFF5RWtjV0ZuUkFvZHNmK2IvWXRw
            SUs0b3grUUR2dnVlY01kVC9ZRXdNaDQKkDf3mtxiDHCfhLSnIzpYIrEgN67M/g4k
            gFh02+kf66v57nFkwAa2G7SDZ7hjvtWwVoDI7v5EMtJGYoNa9UV1nQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2026-01-03T00:27:24Z"
    mac: ENC[AES256_GCM,data:gExazvN/DeV4JKlP0AOtAdplefiym24jBbzow3zDmLaDLbZqtGDdnQaFVDMqvHu6FGbPnX2UHCPMglzqpm7wKgZ8sBG+G8YeXVKOUWzWYWvEI6o9d56QeT9NcxkbN3s8XfkKvJt00lm9Hx5ci41KqqrdLKY5Gvbuw908W3xmDBE=,iv:c9vIsPCzxP1KtEpp42LN8a12Zl4knuFbtXjNzxYLoHk=,tag:3PEOGydRwfN0sWEaOfScjQ==,type:str]
    encrypted_regex: ^(email|password|secret_key|data|stringData|ca|crt|key|id|secret|token|aggregatorCA|serviceAccount|bootstraptoken|secretboxencryptionsecret|secretboxEncryptionSecret|clientSecret|clientId|clientID|external-dns.alpha.kubernetes.io/target|adminPassword|metrics.crt|metrics.key|ca.crt|uri|postgresPassword|preshared|username)$
    version: 3.11.0
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: kube-prometheus-stack
    namespace: kube-prometheus-stack
spec:
    chart:
        spec:
            chart: kube-prometheus-stack
            sourceRef:
                kind: HelmRepository
                name: kube-prometheus-stack
            version: '*'
    interval: 1m0s
    values:
        grafana:
            grafana.ini:
                server:
                    domain: monitoring.phorge.fr
                    root_url: https://monitoring.phorge.fr/
            enabled: true
            adminPassword: ENC[AES256_GCM,data:I8GfmL3o9kClF+6O2Uxud3IjN2fpbz6x,iv:pgXDEmMfOFDNJ9OBPh4MLEZpfrTS5kAWCet4YM6ZH/0=,tag:9HvH/nIJiNbuiauvz8/yMw==,type:str]
            service:
                type: ClusterIP
            ingress:
                enabled: true
                ingressClassName: nginx
                annotations:
                    cert-manager.io/cluster-issuer: letsencrypt
                hosts:
                    - monitoring.phorge.fr
                tls:
                    - secretName: grafana-tls
                      hosts:
                        - monitoring.phorge.fr
            persistence:
                enabled: false
                # accessModes:
                #     - ReadWriteOnce
                # size: 1Gi
        prometheus:
            prometheusSpec:
                nodeSelector:
                    node-role.kubernetes.io/worker: "true"
                retention: 15d
                retentionSize: 19GiB
                serviceMonitorSelector: {}
                secrets:
                    - incus-metrics-credentials
                storageSpec:
                    volumeClaimTemplate:
                        spec:
                            storageClassName: longhorn
                            accessModes:
                                - ReadWriteOnce
                            resources:
                                requests:
                                    storage: 20Gi
                additionalScrapeConfigs:
                    - job_name: incus
                      metrics_path: /1.0/metrics
                      scheme: https
                      static_configs:
                        - targets:
                            - 10.1.0.1:8444
                            - 10.1.0.2:8444
                            - 10.1.0.3:8444
                            - 10.1.0.4:8444
                            - 10.1.0.5:8444
                            - 10.1.0.6:8444
                      tls_config:
                        ca_file: /etc/prometheus/secrets/incus-metrics-credentials/ca.crt
                        cert_file: /etc/prometheus/secrets/incus-metrics-credentials/metrics.crt
                        key_file: /etc/prometheus/secrets/incus-metrics-credentials/metrics.key
                        server_name: iaas.phorge.fr
                        insecure_skip_verify: true
                    - job_name: incus-node-exporter
                      static_configs:
                        - targets:
                            - 10.1.0.1:9100
                            - 10.1.0.2:9100
                            - 10.1.0.3:9100
                            - 10.1.0.4:9100
                            - 10.1.0.5:9100
                            - 10.1.0.6:9100
                    - job_name: hpc-node-exporter
                      static_configs:
                        - targets:
                            - 10.5.0.1:9100
                    - job_name: hpc-gpu-exporter
                      static_configs:
                        - targets:
                            - 10.5.0.1:8000
                    - job_name: hpc-docker-cadvisor-exporter
                      static_configs:
                        - targets:
                            - 10.5.0.1:8080
sops:
    age:
        - recipient: age1ae6yk6xtlt8h40272xqxegz3t3zpvvuxj0jwy489xs6e34k0y9xsvpmt03
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBHcXNjejZIUmpwKzh0OURP
            K3FHMlNmL1BoR09PdE10WXZENWJrWityblQwCkVFc1A5cmphS2dFa0FEZlRNQlNo
            YnlOZndjT2dWc1JCRlVUdFZGZC9naDQKLS0tIFF5RWtjV0ZuUkFvZHNmK2IvWXRw
            SUs0b3grUUR2dnVlY01kVC9ZRXdNaDQKkDf3mtxiDHCfhLSnIzpYIrEgN67M/g4k
            gFh02+kf66v57nFkwAa2G7SDZ7hjvtWwVoDI7v5EMtJGYoNa9UV1nQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2026-01-03T00:27:24Z"
    mac: ENC[AES256_GCM,data:gExazvN/DeV4JKlP0AOtAdplefiym24jBbzow3zDmLaDLbZqtGDdnQaFVDMqvHu6FGbPnX2UHCPMglzqpm7wKgZ8sBG+G8YeXVKOUWzWYWvEI6o9d56QeT9NcxkbN3s8XfkKvJt00lm9Hx5ci41KqqrdLKY5Gvbuw908W3xmDBE=,iv:c9vIsPCzxP1KtEpp42LN8a12Zl4knuFbtXjNzxYLoHk=,tag:3PEOGydRwfN0sWEaOfScjQ==,type:str]
    encrypted_regex: ^(email|password|secret_key|data|stringData|ca|crt|key|id|secret|token|aggregatorCA|serviceAccount|bootstraptoken|secretboxencryptionsecret|secretboxEncryptionSecret|clientSecret|clientId|clientID|external-dns.alpha.kubernetes.io/target|adminPassword|metrics.crt|metrics.key|ca.crt|uri|postgresPassword|preshared|username)$
    version: 3.11.0
---
apiVersion: v1
kind: Secret
metadata:
    name: incus-metrics-credentials
    namespace: kube-prometheus-stack
type: Opaque
stringData:
    metrics.crt: ENC[AES256_GCM,data:GQU0L7D+kX8G4XginNviF1oy8J2nYr5f8w3QZkj3ziri2SLhGYxvPVV4JnoF0syoXWBZIxRnt3rva75ePO4JgZ+PdUn/ZORVv2LH/z7ksw9h7hjFb/WBviAQOHBowD+IDKiYX8jqZvXtNhAF3XmBPY5pYd4xKxEU9PcD6tLIhXnTsRRa8mqC/SakGXgpng4/PyZr9L73aUXHcuPBAJ9mo2mSzKBR1G2P09YeWx4vMcM6oGst+eBx3hbtdfMojoL/oO/w4zB1lU/S2F28Kj6uqx3WOrd4wegWZwsAWgZ+IK0edcoCEcWRgq9b1a1aLO9Heh3THP6U+WY8eFd+fBY3/30Cxa5fYTinYFiB2kTFEgH46LLHM0Ialx9yWnRMGGysLEz3qyyl2N8vlX6nYa3Z8IziaISDG2lcNAAo4cXJyHXM8cReW9jxFqUamsXnvIFBP0OL2KamOTu2pLraZOF5fzn5FEsFY9SR81Toy2Y6IyNz+NTsl05IlAFL0urXGj2678BiOzJB9Zu1neYXfVnZYWD1sCM2h1IPznLs1Lgt8ZG6sL/wi40+0SG4ZZbnQxqqPQUAj+X4YCvJuqrYN54V+cIu7swDqv4GxDjTcBIC2ytHyYp6cKXLlMZ/fTswmKnwRcV+IUxSgju7nq6o3M/9jk2HL/Zdq9tuiufTu6kRMUF7L6MdUKCVu+SKSsCKwNx3ci2mn0dUH908U3UeGJuNFmnViD+Y0Cs8X7je66OFWZ0U6vCVgK38uQvM2uMpwhSCmtCgbjKieGnWIbTsFioUMkKERnLD/1k9zg6eBy8BKu62cEuSdHYpovVRcSJ1qhB9jxhzFelWe9ZsoYSiXMzQUngY8f9y6zwKjOfgtM8NfjHXlztuYupaDbnyrXJXYJEP,iv:zUK5pFIzO5MragEl+XKI4I+1Gvbr3aPPLxa1EfXBnis=,tag:7b6jS1odwvElFuEZJxvBTg==,type:str]
    metrics.key: ENC[AES256_GCM,data:hbZhWRiSdS5TyXSD7mV3CxXMQgcFSpCLclF4y14PiraUGFKQoCZxGcW+1Otb2rwkNybwEUSPgA1RtqjgC7hjN5PtRzZ6qlzwGfZNAxMh5PKBi6LiKn+YHbs6hELvuWB920E5RJ5b9M5l/8gvYMKV47M49UI2mw1T9pLtDORqm1ffihk3ryoGZS7mDf6OhM1wI/eicrB/FVbSfO05zzZNTmGeWzq102USbMmFgiRb069hzA5GpegDekJbQXKQzQcZdsawTjGOnOUjaI13X9pyn7icpRltM6dtrJSIjFJb/iQdzA8uvrFnEN6FIeLjLOfqeBySdJV8VF/UYvUgiDOugWShDiP59cvvp337rtXMtmjJZdgnNhDYurPS5eLwPprgZHlJpgAU6j1BwKJBrY63T4rT,iv:RpF6+YBrhD9azp4OnU1t81hpO98E7wbialo4qtEVZLo=,tag:E7IoZaJNf2Fo0tXQ/R4t3g==,type:str]
    ca.crt: ENC[AES256_GCM,data:0NOgLR60WKfcpGdAKLdDLwQ/FEsEITKFqyfgvQ7wxMjD9AsnlD+SlfukpPe4h/qvQB2COGQ/rcqxv/5x4ONJ/j1aihzMZA+O+L5sXW/pD8wGAQ+tJar7vvgvrmsgDgsvLeByJ5wKuNr/jK/sHTEl3H6T0IDFiMXFMs2vqGkoblOeYAOMBmv7zqqlAGsWi5iWnzu40o4QrBggmp/12TXcrUsGmbuANnCaPGlZHykuNHrQ1TZXpcRa6t9iavcjq61N0SVBadGezCMkTsRU6bPmR0qf4HMHXV9WLlElFeTN8JRsHJS3c3QjIMVVFBI45y6XhqpeyzZgi4VecoeeRlqZK0nOStBVEkGSOu1qRqmAjFWImNI2yhO08Zsvv8XLRgtj0iBC1pSCX5ecYnyhUSAlKzU8tEyI3Eb+/9Dfc5XWfnBRmTUFAgUfNGl9BLXxcRjwXTf+t4uETVZwrsYmA5W8J2LAxTkF81ZPSVHelwsEv7AdyvOeXszVPtljo3E7Hp1Gbb7MnW8Qnf2miahstEfohkvDYPL4/zhp2OJemzs4md7Av5NG03j+S3uo53ZH+Dt89a8K35eUOuH/1LkAnhQ/yb0yI+K70i5P/8Zz9D7fffycgZ/VHeY1W+d50cv9lj0pLwruue4D6vZHUaUUwOgRAx5HoACBSz/4vVUbF4wvxPM25CZGDdz/m+9OcquY9naIotdX7BJDkQcBq2eh1Srv6vqbSDjPZoQk5CwZ7LQ7jWh5JB4K078WwF3cZe7PtD807fl5+3EB658IERmZDcYwSNNiv8OeFsONqXq7xtFUe19KzXVFhUXJGQ/oKGOm2DAgfaCn5wndlmgTpfW1PmYz/VvLHTwfSvS35OxRrQzm3UScTwT4r6l5ZvEuSp10aioPkZN/po4Pk6l4lnC53rsREqdbX41Cd6Psl38srA99xYHWse/4o3uhbK3a/nfxonsSGPBZLlm5q+LkfPaQrEhvPYzNJCLGlzApF12bzKhB/xV8UQTVj2xH82PzqvHKZNPY4AlWqgTY,iv:y6GNRSPkTY9DBr7wbTpMaZG3CQ/M4zyHwnOOBAPfFOk=,tag:l9Z82tPhsOn6000EWmt1qg==,type:str]
sops:
    age:
        - recipient: age1ae6yk6xtlt8h40272xqxegz3t3zpvvuxj0jwy489xs6e34k0y9xsvpmt03
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBHcXNjejZIUmpwKzh0OURP
            K3FHMlNmL1BoR09PdE10WXZENWJrWityblQwCkVFc1A5cmphS2dFa0FEZlRNQlNo
            YnlOZndjT2dWc1JCRlVUdFZGZC9naDQKLS0tIFF5RWtjV0ZuUkFvZHNmK2IvWXRw
            SUs0b3grUUR2dnVlY01kVC9ZRXdNaDQKkDf3mtxiDHCfhLSnIzpYIrEgN67M/g4k
            gFh02+kf66v57nFkwAa2G7SDZ7hjvtWwVoDI7v5EMtJGYoNa9UV1nQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2026-01-03T00:27:24Z"
    mac: ENC[AES256_GCM,data:gExazvN/DeV4JKlP0AOtAdplefiym24jBbzow3zDmLaDLbZqtGDdnQaFVDMqvHu6FGbPnX2UHCPMglzqpm7wKgZ8sBG+G8YeXVKOUWzWYWvEI6o9d56QeT9NcxkbN3s8XfkKvJt00lm9Hx5ci41KqqrdLKY5Gvbuw908W3xmDBE=,iv:c9vIsPCzxP1KtEpp42LN8a12Zl4knuFbtXjNzxYLoHk=,tag:3PEOGydRwfN0sWEaOfScjQ==,type:str]
    encrypted_regex: ^(email|password|secret_key|data|stringData|ca|crt|key|id|secret|token|aggregatorCA|serviceAccount|bootstraptoken|secretboxencryptionsecret|secretboxEncryptionSecret|clientSecret|clientId|clientID|external-dns.alpha.kubernetes.io/target|adminPassword|metrics.crt|metrics.key|ca.crt|uri|postgresPassword|preshared|username)$
    version: 3.11.0
